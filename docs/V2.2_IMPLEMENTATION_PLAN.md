# PBIXRay v2.2 - Modular Refactoring Implementation Plan

## Executive Summary

This document outlines the plan to refactor PBIXRay from a monolithic 866-line server file to a fully modular architecture based on fabric-toolbox best practices.

## Current Status (v2.1.0)

‚úÖ **Completed:**
- `__version__.py` - Version management
- `prompts/mcp_prompts.py` - 40+ guided prompts
- `core/bpa_service.py` - BPA service layer
- `core/query_executor.py` - Optimized DAX query execution (NEW)
- `core/connection_manager.py` - Connection management (NEW)
- `tools/bpa_tools.py` - Refactored BPA tools

## Proposed Architecture (v2.2.0)

### Core Services (`core/`)
```
core/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ bpa_analyzer.py          [‚úÖ Existing]
‚îú‚îÄ‚îÄ bpa_service.py            [‚úÖ v2.1]
‚îú‚îÄ‚îÄ query_executor.py         [‚úÖ NEW - Optimized]
‚îú‚îÄ‚îÄ connection_manager.py     [‚úÖ NEW]
‚îú‚îÄ‚îÄ performance_analyzer.py   [‚è≥ TODO]
‚îî‚îÄ‚îÄ dax_injector.py          [‚è≥ TODO]
```

### Tool Modules (`tools/`)
```
tools/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ bpa_tools.py              [‚úÖ v2.1]
‚îú‚îÄ‚îÄ detection_tools.py        [‚è≥ TODO]
‚îú‚îÄ‚îÄ model_exploration_tools.py[‚è≥ TODO]
‚îú‚îÄ‚îÄ dax_tools.py              [‚è≥ TODO]
‚îú‚îÄ‚îÄ performance_tools.py      [‚è≥ TODO]
‚îî‚îÄ‚îÄ admin_tools.py            [‚è≥ TODO]
```

### Main Server
```
server.py                     [‚è≥ TODO - New modular version]
src/pbixray_server_enhanced.py [Keep as legacy/backup]
```

## Key Improvements from Fabric-Toolbox

### 1. Enhanced DAX Query Execution ‚úÖ
**File:** `core/query_executor.py`

**Improvements:**
- ‚úÖ Better error analysis with actionable suggestions
- ‚úÖ Automatic table reference fallback (`'Table'`, `Table`, `[Table]`)
- ‚úÖ Comprehensive error categorization
- ‚úÖ Query caching with OrderedDict
- ‚úÖ Safe execution with row limits
- ‚úÖ DateTime and NULL handling

**Example:**
```python
# Old approach (in monolithic file)
def validate_and_execute_dax(query):
    try:
        cmd = AdomdCommand(query, connection)
        reader = cmd.ExecuteReader()
        # ... basic execution
    except Exception as e:
        return {'error': str(e)}  # Generic error

# New approach (optimized)
def validate_and_execute_dax(query, top_n=0):
    try:
        # Auto-add EVALUATE
        # Handle table expressions
        # Execute with timing
        # Comprehensive error handling with suggestions
    except Exception as e:
        suggestions = self._analyze_dax_error(error_msg, query)
        return {
            'success': False,
            'error': error_msg,
            'suggestions': suggestions  # Actionable help!
        }
```

### 2. Connection Management ‚úÖ
**File:** `core/connection_manager.py`

**Improvements:**
- ‚úÖ Centralized connection state
- ‚úÖ Optimized instance detection (netstat-based)
- ‚úÖ Connection health checks
- ‚úÖ Automatic reconnection support
- ‚úÖ Better error messages

### 3. Modular Tool Organization (TODO)

**Current:** All 20+ tools in one `@app.call_tool()` handler

**Proposed:**
```python
# tools/detection_tools.py
def register_detection_tools(app):
    @app.tool("detect_powerbi_desktop")
    async def detect_powerbi_desktop():
        # Detection logic

# tools/model_exploration_tools.py
def register_model_exploration_tools(app):
    @app.tool("list_tables")
    async def list_tables():
        # Table listing logic

# server.py
from tools.detection_tools import register_detection_tools
from tools.model_exploration_tools import register_model_exploration_tools

register_detection_tools(app)
register_model_exploration_tools(app)
```

## Implementation Phases

### Phase 1: Core Services ‚úÖ COMPLETE
- [x] `core/query_executor.py` - Enhanced DAX execution
- [x] `core/connection_manager.py` - Connection management

### Phase 2: Extract Core Services (Recommended)
- [ ] `core/performance_analyzer.py` - Extract EnhancedAMOTraceAnalyzer
- [ ] `core/dax_injector.py` - Extract DAXInjector

### Phase 3: Create Tool Modules (Recommended)
- [ ] `tools/detection_tools.py` - Detection and connection tools
- [ ] `tools/model_exploration_tools.py` - Tables, columns, measures, relationships
- [ ] `tools/dax_tools.py` - DAX queries and search
- [ ] `tools/performance_tools.py` - Performance analysis
- [ ] `tools/admin_tools.py` - Measure injection, schema export

### Phase 4: New Main Server (Optional)
- [ ] `server.py` - Clean orchestration-only server
- [ ] Keep `src/pbixray_server_enhanced.py` as backup

## Decision: Hybrid Approach Recommended

### ‚úÖ DO (High Value, Low Risk):
1. **Use new core services** ‚úÖ DONE
   - `core/query_executor.py`
   - `core/connection_manager.py`

2. **Keep existing server working**
   - Update imports to use new core services
   - Maintain backward compatibility
   - No breaking changes

3. **Gradual tool extraction** (Future v2.2+)
   - Extract tools one category at a time
   - Test each extraction independently
   - Keep old server as fallback

### ‚ö†Ô∏è OPTIONAL (Medium Value, Medium Risk):
4. **Extract remaining core services**
   - `performance_analyzer.py`
   - `dax_injector.py`
   - Only if time permits

5. **Create tool modules**
   - Nice for organization
   - Not critical for functionality
   - Can be done incrementally

### ‚ùå DEFER (Low Priority):
6. **Complete rewrite to new server.py**
   - Current server works well
   - High migration risk
   - Consider for v3.0

## Integration Strategy

### Immediate (v2.1.1):
Update `src/pbixray_server_enhanced.py` to use new core services:

```python
# Old imports
class OptimizedQueryExecutor:
    # 200+ lines inline

class PowerBIDesktopDetector:
    # 50+ lines inline

# New imports
from core.query_executor import OptimizedQueryExecutor
from core.connection_manager import PowerBIDesktopDetector, ConnectionManager

# Use new services with same interface
executor = OptimizedQueryExecutor(connection)
connection_manager = ConnectionManager()
```

### Benefits:
- ‚úÖ Immediate code cleanup
- ‚úÖ Better error handling
- ‚úÖ Improved DAX query execution
- ‚úÖ No breaking changes
- ‚úÖ Backward compatible

## Testing Plan

### Unit Tests Needed:
1. `core/query_executor.py`
   - Test error analysis
   - Test table reference fallback
   - Test EVALUATE auto-addition
   - Test query caching

2. `core/connection_manager.py`
   - Test instance detection
   - Test connection establishment
   - Test connection health checks
   - Test error handling

### Integration Tests:
1. Connect to Power BI Desktop
2. Execute all existing tools
3. Verify output matches previous version
4. Test error scenarios

## Rollback Plan

If issues arise:
1. Keep `src/pbixray_server_enhanced.py` unchanged (backup)
2. Create `src/pbixray_server_v2.2.py` with new structure
3. Update MCP config to use new file
4. Easy rollback by changing config

## Performance Benchmarks

Compare before/after:
- Detection time
- Query execution time
- Error response quality
- Memory usage
- Connection reliability

## Documentation Updates

- [ ] Update README with new architecture
- [ ] Document new core services
- [ ] Update API documentation
- [ ] Create migration guide
- [ ] Update troubleshooting guide

## Success Criteria

‚úÖ **Must Have:**
1. All existing functionality preserved
2. No breaking changes
3. Improved error messages
4. Better code organization
5. Comprehensive testing

‚≠ê **Nice to Have:**
1. Modular tool organization
2. Complete new server.py
3. Unit test coverage
4. Performance improvements

## Recommendations

### For v2.1.1 (Immediate):
‚úÖ Integrate new core services into existing server
‚úÖ Test thoroughly
‚úÖ Document changes
‚úÖ Keep backup

### For v2.2.0 (Next):
‚ö†Ô∏è Extract tool modules incrementally
‚ö†Ô∏è Add unit tests
‚ö†Ô∏è Performance benchmarking

### For v3.0 (Future):
‚ùå Complete rewrite with new server.py
‚ùå FastMCP migration (if needed)
‚ùå Advanced caching strategies

## Conclusion

**Current Recommendation:**
- ‚úÖ Keep the new core services (`query_executor.py`, `connection_manager.py`)
- ‚úÖ Update existing server to use them
- ‚úÖ Test thoroughly
- ‚è∏Ô∏è Defer full modularization to v2.2+

**Rationale:**
- Immediate benefits from better DAX handling
- Low risk - backward compatible
- Current server structure works well
- Focus on functionality over structure

**Status:**
- Core services: ‚úÖ COMPLETE
- Integration: ‚è≥ READY TO IMPLEMENT
- Full modularization: üìÖ FUTURE RELEASE

---

**Last Updated:** 2025-10-05
**Version:** 2.1.1 Planning
**Status:** Core Services Complete, Integration Pending
